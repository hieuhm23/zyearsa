name: Build iOS IPA (No Sign)

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-ios:
    name: Build Unsigned IPA
    runs-on: macos-latest
    
    steps:
      - name: üèó Checkout repository
        uses: actions/checkout@v4

      - name: üèó Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: üßπ Clean Cache
        run: |
          npm cache clean --force
          rm -rf node_modules
          rm -rf ios/Pods
          rm -rf ios/build

      - name: üì¶ Install dependencies
        run: npm install

      - name: üî® Prebuild iOS
        run: npx expo prebuild --platform ios --clean
        env:
          EAS_NO_VCS: 1
          EAS_PROJECT_ID: 22440a9f-50a7-4aca-9af3-6a3a1c453321

      - name: üì¶ Install CocoaPods
        run: |
          cd ios
          pod install --repo-update

      - name: üîß Force Remove Signing (Aggressive)
        run: |
          cd ios
          # X√≥a s·∫°ch c√°c thi·∫øt l·∫≠p Signing (Gi·ªØ l·∫°i Entitlements ƒë·ªÉ tr√°nh l·ªói permission)
          find . -name "project.pbxproj" -exec sed -i '' '/CODE_SIGN_IDENTITY/d' {} +
          find . -name "project.pbxproj" -exec sed -i '' '/DEVELOPMENT_TEAM/d' {} +
          find . -name "project.pbxproj" -exec sed -i '' '/PROVISIONING_PROFILE_SPECIFIER/d' {} +
          
          # T·∫Øt b·∫Øt bu·ªôc Signing
          find . -name "project.pbxproj" -exec sed -i '' 's/CODE_SIGNING_REQUIRED = YES/CODE_SIGNING_REQUIRED = NO/g' {} +
          find . -name "project.pbxproj" -exec sed -i '' 's/CODE_SIGNING_ALLOWED = YES/CODE_SIGNING_ALLOWED = NO/g' {} +

      - name: üîç Find project info
        id: project
        run: |
          cd ios
          WORKSPACE=$(ls -d *.xcworkspace | head -1)
          SCHEME=$(echo $WORKSPACE | sed 's/.xcworkspace//')
          echo "workspace=$WORKSPACE" >> $GITHUB_OUTPUT
          echo "scheme=$SCHEME" >> $GITHUB_OUTPUT

      - name: üöÄ Build iOS App (No Sign)
        run: |
          cd ios
          # TƒÉng RAM cho Node v√† T·∫Øt SourceMap ƒë·ªÉ tr√°nh l·ªói OOM
          export NODE_OPTIONS="--max-old-space-size=8192"
          export GENERATE_SOURCEMAP=false
          
          xcodebuild \
            -workspace "${{ steps.project.outputs.workspace }}" \
            -scheme "${{ steps.project.outputs.scheme }}" \
            -configuration Release \
            -sdk iphoneos \
            -destination 'generic/platform=iOS' \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            AD_HOC_CODE_SIGNING_ALLOWED=NO \
            clean build \
            | xcpretty && exit ${PIPESTATUS[0]}

      - name: üì¶ Pack to IPA
        run: |
          APP_PATH=$(find ios/build -name "*.app" -type d | head -1)
          if [ -z "$APP_PATH" ]; then
            echo "‚ùå Error: Build failed (No .app found)."
            exit 1
          fi
          
          mkdir -p Payload
          cp -R "$APP_PATH" Payload/
          zip -r TOKE.ipa Payload
          
      - name: üì§ Upload IPA to GitHub
        uses: actions/upload-artifact@v4
        with:
          name: TOKE-IPA
          path: TOKE.ipa
          retention-days: 7
